<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI éƒµä»¶å›è¦†åŠ©æ‰‹</title>
  <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&family=JetBrains+Mono:wght@400&display=swap');

    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: rgba(255,255,255,0.04);
      --border: rgba(255,255,255,0.08);
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent: #38bdf8;
      --accent-dim: rgba(14,165,233,0.15);
      --success: #22c55e;
      --error: #ef4444;
      --claude: #D97706;
      --openai: #10A37F;
      --gemini: #4285F4;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Noto Sans TC', 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 13px;
      line-height: 1.6;
      overflow-y: auto;
    }

    .header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,0.2);
      display: flex; justify-content: space-between; align-items: center;
    }
    .header h1 {
      font-size: 16px; font-weight: 700;
      background: linear-gradient(135deg, #38bdf8, #818cf8, #c084fc);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .header-actions { display: flex; gap: 6px; }

    .lang-toggle {
      display: flex; border-radius: 8px; overflow: hidden;
      border: 1px solid var(--border);
    }
    .lang-toggle button {
      padding: 4px 12px; border: none; background: transparent;
      color: var(--text-muted); cursor: pointer; font-size: 12px;
    }
    .lang-toggle button.active {
      background: var(--accent-dim); color: var(--accent); font-weight: 600;
    }

    .content { padding: 16px; display: flex; flex-direction: column; gap: 14px; }

    /* Provider Tabs */
    .provider-tabs { display: flex; gap: 6px; flex-wrap: wrap; }
    .provider-tab {
      display: flex; align-items: center; gap: 6px;
      padding: 8px 14px; border: 2px solid transparent;
      border-radius: 10px; background: var(--bg-card);
      color: var(--text-muted); cursor: pointer; font-size: 12px;
      position: relative; transition: all 0.2s;
    }
    .provider-tab.active { border-color: var(--active-color); background: var(--active-bg); color: var(--active-color); font-weight: 600; }
    .provider-tab .dot {
      width: 7px; height: 7px; border-radius: 50%; background: var(--success);
      position: absolute; top: 4px; right: 4px;
    }
    .provider-icon { font-size: 16px; }

    /* Form Elements */
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-label { font-size: 12px; color: var(--text-muted); font-weight: 600; }

    input[type="password"], input[type="text"], select {
      width: 100%; padding: 8px 12px; background: rgba(0,0,0,0.3);
      border: 1px solid var(--border); border-radius: 8px;
      color: var(--text-primary); font-size: 12px; outline: none;
    }
    input:focus, select:focus { border-color: rgba(14,165,233,0.5); }
    select { cursor: pointer; }

    .key-row { display: flex; gap: 8px; align-items: flex-end; }
    .key-row .flex1 { flex: 1; }

    .btn {
      padding: 8px 16px; border: none; border-radius: 8px;
      cursor: pointer; font-size: 12px; font-weight: 600;
      transition: all 0.2s; white-space: nowrap;
    }
    .btn-save { background: var(--accent); color: #fff; }
    .btn-delete { background: rgba(239,68,68,0.15); color: var(--error); border: 1px solid rgba(239,68,68,0.3); }
    .btn-generate {
      width: 100%; padding: 12px; font-size: 14px; font-weight: 700;
      background: linear-gradient(135deg, #0ea5e9, #8b5cf6);
      color: #fff; border: none; border-radius: 10px; cursor: pointer;
      box-shadow: 0 4px 16px rgba(14,165,233,0.3);
    }
    .btn-generate:disabled { background: #334155; box-shadow: none; cursor: not-allowed; }

    .btn-copy {
      padding: 4px 10px; background: var(--accent-dim); color: var(--accent);
      border: 1px solid rgba(14,165,233,0.3); border-radius: 6px;
      cursor: pointer; font-size: 11px; font-weight: 600;
    }

    /* Tone Chips */
    .tone-chips { display: flex; gap: 6px; flex-wrap: wrap; }
    .tone-chip {
      padding: 6px 12px; border: 1px solid var(--border);
      border-radius: 8px; background: var(--bg-card);
      color: var(--text-muted); cursor: pointer; font-size: 12px;
      transition: all 0.2s;
    }
    .tone-chip.active {
      background: var(--accent-dim); border-color: rgba(14,165,233,0.4);
      color: var(--accent); font-weight: 600;
    }

    /* Email Preview */
    .email-preview {
      background: var(--bg-card); border-radius: 10px;
      border: 1px solid var(--border); padding: 12px;
    }
    .email-preview-header {
      font-size: 11px; color: var(--text-muted); margin-bottom: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .email-body {
      font-size: 12px; color: var(--text-secondary);
      white-space: pre-wrap; max-height: 200px; overflow-y: auto;
      line-height: 1.7;
    }

    /* Additional Context */
    textarea {
      width: 100%; padding: 10px 12px; background: rgba(0,0,0,0.2);
      border: 1px solid var(--border); border-radius: 8px;
      color: var(--text-primary); font-size: 12px; resize: vertical;
      outline: none; font-family: 'Noto Sans TC', sans-serif;
      line-height: 1.6; min-height: 60px;
    }

    /* Response */
    .response-section {
      background: var(--bg-card); border-radius: 12px;
      border: 1px solid var(--border); padding: 14px;
      animation: slideIn 0.3s ease-out;
    }
    .response-section.reply {
      background: rgba(14,165,233,0.06);
      border-color: rgba(14,165,233,0.2);
    }
    .response-title {
      font-size: 12px; font-weight: 700; margin-bottom: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .response-title.reply-title { color: var(--accent); }
    .response-body {
      font-size: 13px; color: var(--text-secondary);
      white-space: pre-wrap; line-height: 1.7;
    }

    .error-box {
      padding: 10px 14px; background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.3); border-radius: 8px;
      color: #fca5a5; font-size: 12px;
    }

    .loading { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
    @keyframes slideIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

    .saved-keys { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
    .saved-key-badge {
      padding: 3px 10px; border-radius: 16px; font-size: 11px;
      border: 1px solid;
    }

    .settings-toggle {
      padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border);
      background: transparent; color: var(--text-muted); cursor: pointer; font-size: 12px;
    }
    .settings-toggle.active { background: var(--accent-dim); color: var(--accent); border-color: rgba(14,165,233,0.3); }

    /* Floater */
    .brand-badge {
      position: fixed; bottom: 12px; right: 12px;
      display: flex; align-items: center; gap: 6px;
      padding: 6px 10px; background: rgba(30,41,59,0.95);
      backdrop-filter: blur(20px); border-radius: 40px;
      border: 1px solid rgba(255,255,255,0.1);
      text-decoration: none; color: #f8fafc; z-index: 1000;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3); transition: all 0.3s;
    }
    .brand-badge:hover { transform: translateY(-2px); border-color: #0ea5e9; }
    .brand-badge strong {
      font-size: 0.7rem; font-weight: 600;
      background: linear-gradient(135deg, #e63946, #f4a261, #2a9d8f, #264653, #e76f51);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .brand-badge span { font-size: 0.6rem; color: #94a3b8; }
    .brand-badge svg { width: 16px; height: 16px; fill: #0ea5e9; }
  </style>
</head>
<body>
  <div class="header">
    <h1 id="headerTitle">AI éƒµä»¶å›è¦†åŠ©æ‰‹</h1>
    <div class="header-actions">
      <div class="lang-toggle">
        <button class="active" onclick="setLang('zh')">ä¸­æ–‡</button>
        <button onclick="setLang('en')">EN</button>
      </div>
      <button class="settings-toggle active" onclick="toggleSettings()" id="settingsBtn">âš™ï¸</button>
    </div>
  </div>

  <div class="content">
    <!-- Settings Panel -->
    <div id="settingsPanel">
      <div class="provider-tabs" id="providerTabs"></div>
      <div class="form-group">
        <div class="key-row">
          <div class="flex1">
            <label class="form-label">API Key</label>
            <input type="password" id="apiKeyInput" placeholder="Enter API Key..." />
          </div>
          <div style="width:100px">
            <label class="form-label">Label</label>
            <input type="text" id="labelInput" placeholder="e.g. å…¬å¸ç”¨" />
          </div>
        </div>
      </div>
      <div class="form-group">
        <div class="key-row">
          <div class="flex1">
            <label class="form-label">Model</label>
            <select id="modelSelect"></select>
          </div>
          <button class="btn btn-save" onclick="saveKey()">ğŸ’¾ Save</button>
          <button class="btn btn-delete" onclick="removeKey()" id="deleteBtn" style="display:none">ğŸ—‘</button>
        </div>
      </div>
      <div class="saved-keys" id="savedKeys"></div>
    </div>

    <!-- Email Content -->
    <div class="email-preview">
      <div class="email-preview-header">
        <span id="emailLabel">ğŸ“¨ ä¾†ä¿¡å…§å®¹ï¼ˆè‡ªå‹•è®€å–ï¼‰</span>
        <button class="btn-copy" onclick="refreshEmail()" id="refreshBtn">ğŸ”„ é‡æ–°è®€å–</button>
      </div>
      <div class="email-body" id="emailBody">æ­£åœ¨è®€å–éƒµä»¶å…§å®¹...</div>
    </div>

    <!-- Additional Context -->
    <div class="form-group">
      <label class="form-label" id="contextLabel">ğŸ’¡ é¡å¤–æŒ‡ç¤ºï¼ˆé¸å¡«ï¼‰</label>
      <textarea id="contextInput" placeholder="ä¾‹å¦‚ï¼šè«‹å©‰æ‹’é€™å€‹éœ€æ±‚ï¼Œä½†æä¾›æ›¿ä»£æ–¹æ¡ˆ..." rows="2"></textarea>
    </div>

    <!-- Tone Selection -->
    <div class="form-group">
      <label class="form-label" id="toneLabel">ğŸ­ å›è¦†èªæ°£</label>
      <div class="tone-chips" id="toneChips"></div>
    </div>

    <!-- Generate -->
    <button class="btn btn-generate" id="generateBtn" onclick="generateReply()">
      ğŸš€ ç”¢ç”Ÿå›è¦†
    </button>

    <!-- Error -->
    <div class="error-box" id="errorBox" style="display:none"></div>

    <!-- Response -->
    <div id="responseArea"></div>
  </div>

  <!-- PM Mayors Floater -->
  <a href="https://pmmayors.com" target="_blank" rel="noopener noreferrer" class="brand-badge">
    <div style="display:flex;flex-direction:column">
      <strong>PM Mayors</strong>
      <span>Where Taiwan AI PM Initiated</span>
    </div>
    <svg viewBox="0 0 24 24"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm-1 17.93V18c0-.55-.45-1-1-1H8v-2c0-.55-.45-1-1-1H5.07C4.4 12.68 4 11.38 4 10c0-2.1.8-4 2.1-5.45C6.7 6.02 8 7 8 8v1c0 1.1.9 2 2 2 .55 0 1 .45 1 1v2c0 1.1.9 2 2 2s2-.9 2-2v-1c.55 0 1-.45 1-1 0-.55.45-1 1-1h.93c.42 1.3.57 2.73.35 4.22-.31 2.08-1.38 3.97-3 5.33-.55.46-1.14.86-1.78 1.18C12.75 19.91 12.38 19.97 11 19.93z"/></svg>
  </a>

<script>
// ============================================================
// State
// ============================================================
const PROVIDERS = {
  anthropic: { id:'anthropic', name:'Claude', icon:'âœ¦', color:'#D97706',
    models:['claude-sonnet-4-20250514','claude-haiku-4-5-20250929','claude-opus-4-0-20250514'] },
  openai: { id:'openai', name:'GPT', icon:'â—ˆ', color:'#10A37F',
    models:['gpt-4o','gpt-4o-mini','gpt-4-turbo','o1-mini'] },
  gemini: { id:'gemini', name:'Gemini', icon:'â—†', color:'#4285F4',
    models:['gemini-2.0-flash','gemini-1.5-pro','gemini-1.5-flash'] }
};

const TONES = {
  professional: { zh:'å°ˆæ¥­æ­£å¼', en:'Professional', emoji:'ğŸ‘”' },
  friendly: { zh:'è¦ªåˆ‡å‹å–„', en:'Friendly', emoji:'ğŸ˜Š' },
  firm: { zh:'å …å®šç«‹å ´', en:'Firm', emoji:'ğŸ’ª' },
  empathetic: { zh:'åŒç†é—œæ‡·', en:'Empathetic', emoji:'ğŸ¤' },
  concise: { zh:'ç°¡æ½”æ‰¼è¦', en:'Concise', emoji:'âš¡' },
  diplomatic: { zh:'åœ“èå¤–äº¤', en:'Diplomatic', emoji:'ğŸ•Šï¸' }
};

let state = {
  keys: JSON.parse(localStorage.getItem('outlook-ai-keys') || '{}'),
  activeProvider: 'anthropic',
  lang: 'zh',
  tone: 'professional',
  emailContent: '',
  showSettings: true,
  loading: false
};

// ============================================================
// Outlook Office.js Integration
// ============================================================
Office.onReady(function(info) {
  if (info.host === Office.HostType.Outlook) {
    readEmail();
  }
});

function readEmail() {
  try {
    const item = Office.context.mailbox.item;
    if (!item) {
      document.getElementById('emailBody').textContent = state.lang === 'zh'
        ? 'è«‹å…ˆé¸æ“‡ä¸€å°éƒµä»¶' : 'Please select an email first';
      return;
    }
    item.body.getAsync(Office.CoercionType.Text, function(result) {
      if (result.status === Office.AsyncResultStatus.Succeeded) {
        state.emailContent = result.value;
        document.getElementById('emailBody').textContent = result.value || (state.lang === 'zh' ? 'ï¼ˆéƒµä»¶å…§å®¹ç‚ºç©ºï¼‰' : '(Empty email)');
      } else {
        document.getElementById('emailBody').textContent = state.lang === 'zh'
          ? 'ç„¡æ³•è®€å–éƒµä»¶å…§å®¹' : 'Unable to read email content';
      }
    });
  } catch(e) {
    // Fallback for testing outside Outlook
    document.getElementById('emailBody').textContent = state.lang === 'zh'
      ? 'âš ï¸ æœªåœ¨ Outlook ç’°å¢ƒä¸­ã€‚è«‹æ‰‹å‹•è²¼ä¸Šéƒµä»¶å…§å®¹é€²è¡Œæ¸¬è©¦ã€‚'
      : 'âš ï¸ Not in Outlook. Paste email content manually to test.';
    document.getElementById('emailBody').setAttribute('contenteditable', 'true');
    document.getElementById('emailBody').style.minHeight = '100px';
    document.getElementById('emailBody').addEventListener('input', function() {
      state.emailContent = this.textContent;
    });
  }
}

function refreshEmail() { readEmail(); }

// ============================================================
// API Calls
// ============================================================
function buildSystemPrompt() {
  const toneLabel = state.lang === 'zh' ? TONES[state.tone].zh : TONES[state.tone].en;
  if (state.lang === 'zh') {
    return `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ä¼æ¥­éƒµä»¶å›è¦†åŠ©æ‰‹ã€‚è«‹åˆ†æä»¥ä¸‹ä¾†ä¿¡å…§å®¹ï¼Œç†è§£å°æ–¹çš„å•é¡Œå’Œéœ€æ±‚ï¼Œç„¶å¾Œç”¨ã€Œ${toneLabel}ã€çš„èªæ°£ï¼Œä»¥ç¹é«”ä¸­æ–‡æ’°å¯«ä¸€å°å›è¦†éƒµä»¶ã€‚\n\nè¦å‰‡ï¼š\n1. å…ˆç°¡è¦æ‘˜è¦ä¾†ä¿¡é‡é»ï¼ˆ2-3 å¥ï¼‰\n2. è­˜åˆ¥éœ€è¦å›æ‡‰çš„é—œéµå•é¡Œ\n3. æ’°å¯«å®Œæ•´çš„å›è¦†éƒµä»¶ï¼ˆåŒ…å«ç¨±å‘¼ã€æ­£æ–‡ã€çµå°¾ï¼‰\n4. å›è¦†éœ€è¦æœ‰æ¢ç†ã€å°ˆæ¥­ã€é©ç•¶\n\nè«‹ç”¨ä»¥ä¸‹æ ¼å¼è¼¸å‡ºï¼š\nã€ä¾†ä¿¡æ‘˜è¦ã€‘\nï¼ˆæ‘˜è¦å…§å®¹ï¼‰\n\nã€é—œéµå•é¡Œã€‘\nï¼ˆå•é¡Œåˆ—è¡¨ï¼‰\n\nã€å»ºè­°å›è¦†ã€‘\nï¼ˆå®Œæ•´å›è¦†éƒµä»¶å…§å®¹ï¼‰`;
  }
  return `You are a professional email reply assistant. Analyze the incoming email, understand the sender's issues and needs, then compose a reply in a "${toneLabel}" tone in English.\n\nRules:\n1. Briefly summarize the key points (2-3 sentences)\n2. Identify key issues that need addressing\n3. Write a complete reply email (greeting, body, closing)\n4. Keep the reply organized, professional, and appropriate\n\nOutput format:\nã€Email Summaryã€‘\n(summary)\n\nã€Key Issuesã€‘\n(issues list)\n\nã€Suggested Replyã€‘\n(full reply email)`;
}

async function callAPI(provider, key, model, systemPrompt, userMsg) {
  switch(provider) {
    case 'anthropic': {
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method:'POST',
        headers: {
          'Content-Type':'application/json',
          'x-api-key': key,
          'anthropic-version':'2023-06-01',
          'anthropic-dangerous-direct-browser-access':'true'
        },
        body: JSON.stringify({ model, max_tokens:2048, system:systemPrompt, messages:[{role:'user',content:userMsg}] })
      });
      if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.error?.message || 'Anthropic API error: '+res.status); }
      const data = await res.json();
      return data.content?.map(b=>b.text).join('\n') || '';
    }
    case 'openai': {
      const res = await fetch('https://api.openai.com/v1/chat/completions', {
        method:'POST',
        headers: { 'Content-Type':'application/json', 'Authorization':'Bearer '+key },
        body: JSON.stringify({ model, max_tokens:2048, messages:[{role:'system',content:systemPrompt},{role:'user',content:userMsg}] })
      });
      if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.error?.message || 'OpenAI API error: '+res.status); }
      const data = await res.json();
      return data.choices?.[0]?.message?.content || '';
    }
    case 'gemini': {
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
      const res = await fetch(url, {
        method:'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({
          system_instruction:{parts:[{text:systemPrompt}]},
          contents:[{parts:[{text:userMsg}]}],
          generationConfig:{maxOutputTokens:2048}
        })
      });
      if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.error?.message || 'Gemini API error: '+res.status); }
      const data = await res.json();
      return data.candidates?.[0]?.content?.parts?.map(p=>p.text).join('\n') || '';
    }
  }
}

async function generateReply() {
  const emailContent = state.emailContent || document.getElementById('emailBody').textContent;
  if (!emailContent.trim()) return;
  const keyData = state.keys[state.activeProvider];
  if (!keyData?.key) {
    showError(state.lang === 'zh' ? 'è«‹å…ˆè¨­å®š API Key' : 'Please set up API Key first');
    return;
  }

  state.loading = true;
  const btn = document.getElementById('generateBtn');
  btn.disabled = true;
  btn.textContent = state.lang === 'zh' ? 'â³ AI åˆ†æä¸­...' : 'â³ Generating...';
  btn.classList.add('loading');
  hideError();

  const systemPrompt = buildSystemPrompt();
  let userMsg = emailContent.trim();
  const ctx = document.getElementById('contextInput').value.trim();
  if (ctx) userMsg += '\n\n---\n' + (state.lang==='zh'?'é¡å¤–æŒ‡ç¤º':'Additional Context') + ': ' + ctx;

  try {
    const result = await callAPI(state.activeProvider, keyData.key, keyData.model, systemPrompt, userMsg);
    renderResponse(result);
  } catch(err) {
    showError(err.message);
  } finally {
    state.loading = false;
    btn.disabled = false;
    btn.textContent = state.lang === 'zh' ? 'ğŸš€ ç”¢ç”Ÿå›è¦†' : 'ğŸš€ Generate Reply';
    btn.classList.remove('loading');
  }
}

// ============================================================
// UI Rendering
// ============================================================
function renderProviderTabs() {
  const el = document.getElementById('providerTabs');
  el.innerHTML = Object.values(PROVIDERS).map(p => `
    <button class="provider-tab ${state.activeProvider===p.id?'active':''}"
            style="--active-color:${p.color}; --active-bg:${p.color}15"
            onclick="selectProvider('${p.id}')">
      <span class="provider-icon">${p.icon}</span>
      <span>${p.name}</span>
      ${state.keys[p.id]?.key ? '<span class="dot"></span>' : ''}
    </button>
  `).join('');
}

function renderModelSelect() {
  const provider = PROVIDERS[state.activeProvider];
  const select = document.getElementById('modelSelect');
  select.innerHTML = provider.models.map(m => `<option value="${m}" style="background:#1e293b">${m}</option>`).join('');
  const keyData = state.keys[state.activeProvider];
  if (keyData) {
    select.value = keyData.model || provider.models[0];
    document.getElementById('apiKeyInput').value = keyData.key || '';
    document.getElementById('labelInput').value = keyData.label || '';
    document.getElementById('deleteBtn').style.display = 'inline-block';
  } else {
    document.getElementById('apiKeyInput').value = '';
    document.getElementById('labelInput').value = '';
    document.getElementById('deleteBtn').style.display = 'none';
  }
}

function renderToneChips() {
  document.getElementById('toneChips').innerHTML = Object.entries(TONES).map(([key, val]) => `
    <button class="tone-chip ${state.tone===key?'active':''}" onclick="selectTone('${key}')">
      ${val.emoji} ${state.lang==='zh'?val.zh:val.en}
    </button>
  `).join('');
}

function renderSavedKeys() {
  const el = document.getElementById('savedKeys');
  el.innerHTML = Object.entries(state.keys).map(([pid, data]) => `
    <span class="saved-key-badge" style="background:${PROVIDERS[pid].color}20; color:${PROVIDERS[pid].color}; border-color:${PROVIDERS[pid].color}40">
      ${PROVIDERS[pid].icon} ${data.label || PROVIDERS[pid].name} â€¢ ${data.model}
    </span>
  `).join('');
}

function renderResponse(text) {
  const sections = text.split(/ã€(.+?)ã€‘/).filter(Boolean);
  const parsed = [];
  for (let i = 0; i < sections.length; i += 2) {
    if (sections[i+1]) parsed.push({ title: sections[i], content: sections[i+1].trim() });
  }

  const area = document.getElementById('responseArea');
  if (parsed.length === 0) {
    area.innerHTML = `<div class="response-section"><div class="response-body">${escapeHtml(text)}</div></div>`;
    return;
  }

  area.innerHTML = parsed.map(s => {
    const isReply = s.title.includes('å›è¦†') || s.title.includes('Reply');
    return `
      <div class="response-section ${isReply?'reply':''}" style="margin-bottom:10px">
        <div class="response-title ${isReply?'reply-title':''}">
          <span style="color:${isReply?'var(--accent)':'var(--text-muted)'}">${escapeHtml(s.title)}</span>
          ${isReply ? `<button class="btn-copy" onclick="copyText(this)">${state.lang==='zh'?'ğŸ“‹ è¤‡è£½å›è¦†':'ğŸ“‹ Copy'}</button>` : ''}
        </div>
        <div class="response-body">${escapeHtml(s.content)}</div>
      </div>
    `;
  }).join('');
}

// ============================================================
// Actions
// ============================================================
function selectProvider(id) {
  state.activeProvider = id;
  renderProviderTabs(); renderModelSelect(); renderSavedKeys();
}

function selectTone(tone) {
  state.tone = tone;
  renderToneChips();
}

function setLang(lang) {
  state.lang = lang;
  document.querySelectorAll('.lang-toggle button').forEach(b => b.classList.remove('active'));
  document.querySelector(`.lang-toggle button:${lang==='zh'?'first':'last'}-child`).classList.add('active');
  updateLabels();
  renderToneChips();
}

function toggleSettings() {
  state.showSettings = !state.showSettings;
  document.getElementById('settingsPanel').style.display = state.showSettings ? 'block' : 'none';
  document.getElementById('settingsBtn').classList.toggle('active', state.showSettings);
}

function saveKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key) return;
  state.keys[state.activeProvider] = {
    key,
    model: document.getElementById('modelSelect').value,
    label: document.getElementById('labelInput').value.trim()
  };
  localStorage.setItem('outlook-ai-keys', JSON.stringify(state.keys));
  renderProviderTabs(); renderSavedKeys();
  document.getElementById('deleteBtn').style.display = 'inline-block';
}

function removeKey() {
  delete state.keys[state.activeProvider];
  localStorage.setItem('outlook-ai-keys', JSON.stringify(state.keys));
  renderProviderTabs(); renderModelSelect(); renderSavedKeys();
}

function showError(msg) {
  const el = document.getElementById('errorBox');
  el.textContent = 'âš ï¸ ' + msg;
  el.style.display = 'block';
}
function hideError() { document.getElementById('errorBox').style.display = 'none'; }

function copyText(btn) {
  const text = btn.parentElement.nextElementSibling.textContent;
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = state.lang==='zh' ? 'âœ… å·²è¤‡è£½' : 'âœ… Copied';
    setTimeout(() => { btn.textContent = state.lang==='zh' ? 'ğŸ“‹ è¤‡è£½å›è¦†' : 'ğŸ“‹ Copy'; }, 2000);
  });
}

function escapeHtml(text) {
  return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

function updateLabels() {
  const zh = state.lang === 'zh';
  document.getElementById('headerTitle').textContent = zh ? 'AI éƒµä»¶å›è¦†åŠ©æ‰‹' : 'AI Email Reply Assistant';
  document.getElementById('emailLabel').textContent = zh ? 'ğŸ“¨ ä¾†ä¿¡å…§å®¹ï¼ˆè‡ªå‹•è®€å–ï¼‰' : 'ğŸ“¨ Email Content (Auto-read)';
  document.getElementById('refreshBtn').textContent = zh ? 'ğŸ”„ é‡æ–°è®€å–' : 'ğŸ”„ Refresh';
  document.getElementById('contextLabel').textContent = zh ? 'ğŸ’¡ é¡å¤–æŒ‡ç¤ºï¼ˆé¸å¡«ï¼‰' : 'ğŸ’¡ Additional Context (Optional)';
  document.getElementById('contextInput').placeholder = zh ? 'ä¾‹å¦‚ï¼šè«‹å©‰æ‹’é€™å€‹éœ€æ±‚ï¼Œä½†æä¾›æ›¿ä»£æ–¹æ¡ˆ...' : 'e.g. Politely decline but offer alternatives...';
  document.getElementById('toneLabel').textContent = zh ? 'ğŸ­ å›è¦†èªæ°£' : 'ğŸ­ Reply Tone';
  document.getElementById('generateBtn').textContent = zh ? 'ğŸš€ ç”¢ç”Ÿå›è¦†' : 'ğŸš€ Generate Reply';
}

// ============================================================
// Initialize
// ============================================================
renderProviderTabs();
renderModelSelect();
renderToneChips();
renderSavedKeys();
</script>
</body>
</html>
